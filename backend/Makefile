.PHONY: build run stop logs clean test help

# Nom de l'image Docker
IMAGE_NAME := oshii-backend
PORT := 3000

# Couleurs pour les messages
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m # No Color

help: ## Afficher l'aide
	@echo "$(GREEN)‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ$(NC)"
	@echo "$(GREEN)  üê≥ Makefile - Backend Oshii$(NC)"
	@echo "$(GREEN)‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ$(NC)"
	@echo ""
	@echo "$(YELLOW)Commandes disponibles:$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2}'
	@echo ""

build: ## Construire l'image Docker
	@echo "$(YELLOW)üì¶ Construction de l'image Docker...$(NC)"
	docker build -t $(IMAGE_NAME) .
	@echo "$(GREEN)‚úÖ Image construite avec succ√®s!$(NC)"

run: ## Lancer le conteneur (n√©cessite .env)
	@echo "$(YELLOW)üöÄ D√©marrage du conteneur...$(NC)"
	docker run -d --name $(IMAGE_NAME) -p $(PORT):3000 --env-file .env $(IMAGE_NAME)
	@echo "$(GREEN)‚úÖ Conteneur d√©marr√© sur http://localhost:$(PORT)$(NC)"

start: build run ## Construire et lancer le conteneur

stop: ## Arr√™ter le conteneur
	@echo "$(YELLOW)üõë Arr√™t du conteneur...$(NC)"
	@docker stop $(IMAGE_NAME) 2>/dev/null || true
	@docker rm $(IMAGE_NAME) 2>/dev/null || true
	@echo "$(GREEN)‚úÖ Conteneur arr√™t√©$(NC)"

restart: stop start ## Red√©marrer le conteneur

logs: ## Afficher les logs du conteneur
	docker logs -f $(IMAGE_NAME)

clean: stop ## Nettoyer l'image et le conteneur
	@echo "$(YELLOW)üßπ Nettoyage...$(NC)"
	@docker rmi $(IMAGE_NAME) 2>/dev/null || true
	@echo "$(GREEN)‚úÖ Nettoyage termin√©$(NC)"

test: ## Tester l'API
	@echo "$(YELLOW)üß™ Test de l'API...$(NC)"
	@curl -s http://localhost:$(PORT)/health | python3 -m json.tool || echo "$(RED)‚ùå API non accessible$(NC)"

shell: ## Ouvrir un shell dans le conteneur
	docker exec -it $(IMAGE_NAME) sh

stats: ## Afficher les statistiques du conteneur
	docker stats $(IMAGE_NAME)

